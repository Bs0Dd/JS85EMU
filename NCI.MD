# НЦИ - Накопитель Цифровой Информации

НЦИ использовался для неких измерений на трубопроводах. Прошивка запрашивает номер трубопровода, код ситуации, текущую точку в км, расстояние между электродами.
Сами измерения осуществлялись через однобитовый цифровой вход (PP6) неизвестным образом.

## Распределение памяти

0000-7FFF	ПЗУ 32КБ (M27C256 на плате НЦИ)
8000-87FF	ОЗУ	2КБ (Т36РУ2-1 на плате МК)
A000-BFFF	Окно ОЗУ 32КБ (GM76C256 на плате НЦИ), PP13:PP12 - старшие разряды адреса (выбор банка)
C000		Регистр адреса КР512ВИ1. Шина данных инвертирована процессором!
C001		Регистр данных КР512ВИ1. Шина данных инвертирована процессором!

## Назначение сигналов параллельного порта

PP6		I	Вход данных
PP7		I	Software UART ACK
PP8		O	Software UART TxD
PP9		O	Включение приёмника данных (1-активен)
PP11	O	КР512ВИ1 CE ? (1-активен, взводится перед обращениями к RTC, сбрасывается после)
PP12	O	A13 ОЗУ 32КБ
PP13	O	A14 ОЗУ 32КБ

## Доработки Эмулятора

## Эмуляция чтения регистра параллельного порта

Прошивка НЦИ использует 16-битовые команды bis/bic для манипуляции отдельными битами PP. Это потребовало поддержки чтения предыдущего значения PP.

## Эмуляция расширенного ОЗУ 32КБ с переключаемыми банками

Расширенное ОЗУ доступно через окно размером 8КБ по адресу 0xA000, текущий банк задаётся битами PP13:PP12

## Эмуляция часов реального времени КР512ВИ1

Добавлена базовая эмуляция часов (64 байта памяти, регистры даты/времени возвращают текущие системные дату/время).

### Не реализовано

- Часы явно умеют будить ЦП, в коде немало мест, где в часах выставляется будильник и разрешается прерывание по нему, после чего ЦП засыпает.
- Пробуждение раз в секунду? Эмуляция НЦИ показывает текущие дату/время при старте , дальше показания часов не меняются. Должны ли они меняться?

### 16-битовые операции по нечётным адресам

Прошивка НЦИ минимум в двух местах осуществляет 16-битовый доступ к ОЗУ по нечётным адресам. Это не повреждения ПЗУ, в одном из случаев (адрес 0x40B0)
команда *tst -(R1)* используется в качестве *R1=R1-2*, по логике окружающего кода именно это вычитание 2 там и нужно.
Реализация ядра PDP-11 в эмуляторе запрещала подобные действия (возбуждая исключение TRAP_BUS_ERROR), вызывая зацикливание прошивки. После отключения
данной проверки прошивка заработала. **Остался неясным момент, как именно Т36ВМ1-2 обрабатывает подобные операции, происходит ли доступ к нечётному
адресу и следующему за ним чётному (инкремент адреса, оставлен этот вариант), либо к предыдущему чётному (маскирование разряда A0). Для вышеупомянутой
команды tst это не важно, её результат не используется. Вторая подобная операция (в функции очистки буфера ввода по 0x46F2) предполагает инкремент.**
